### 一致性哈希

- 经典服务器架构
  可以用于解决经典服务器架构问题，经典服务器架构的话会有一台前端web服务器和多台后台服务器，
  前端web服务器负责分发请求到后台服务器，分发逻辑是这样的，前端服务器通过请求的key(可以是ip地址)进行哈希处理，
  再讲该哈希值模以后台服务器数量，这样请求会均匀的分发到每台服务器上面。

但是该架构在新增或减少后台机器时就会发生数据迁移问题，例如原本A请求的数据是存放在A机器的，新增服务器后哈希值模以4，
可能会分发到其他服务器，这时候A机器上缓存中的数据就需要迁移到另外一台服务器上，数据迁移很繁琐和复杂。

- 一致性哈希
1. 假设哈希函数产生的域是0-2^64次方，将产生的哈希域想象成一个首位相连的环，0 1 2 ... 一直连接到2^64次方
2. 设定前端与后端服务器均是以ip地址作为哈希函数的输入，我们将后端服务器的ip地址做哈希处理，产生的值分布到哈希域环中。
3. web服务器会存储排序后的后端服务器哈希值，当请求过来时将请求的ip地址哈希处理，将产生的哈希值在后端哈希列表中二分的对比，
    大于该值的哈希值所对应的服务器便是要分发的服务器。

新增服务器与减少服务器的状态
    新增服务器时会将ip地址哈细化分布到哈希环中，也就是说该服务器在哈希环中逆时针碰到的服务器这段哈希域都属于新增服务器处理的范畴，这段哈希域原本是属于顺时针碰到的服务器处理的，数据迁移时只需要把顺时针碰到的服务器所管辖的这段环中的数据迁移到新增服务器即可，
    移除服务器也是相同的道理。

缺点1：哈希函数只有在输入域数量起来的时候，哈希的特性才能发挥，如果在机器少的时候，没办法保证机器是平均分布在哈希环上面的，这样机器负载就不均衡了。
缺点2：即使原始场景机器负载均衡了，但是在加机器后，就会破坏哈希环原本均衡的状态。

引入虚拟节点便可以解决这俩个缺点。
假设有3台机器，让每一台机器对应1万个虚拟节点，这样将会有3万个虚拟节点，每个虚拟节点都是通过哈希函数计算出来的，
这样这每台机器就会在哈希环上占据3分之一段，这是当哈希值量起来的时候。

那么在加机器的时候，例如加第四台机器，这时候每台机器就在哈希环上就占据4分之一段，也就是说原先每天机器会有4分之一请求被占据了。

如何算出虚拟节点，假设机器1的ip是192.24.22.11，将其当做字符串处理，让-1类似的后缀加载iip上，然后进行哈细化处理，这样虚拟出了10000虚拟节点了。